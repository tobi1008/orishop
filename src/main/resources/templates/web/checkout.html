<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{decorators/main}">

<head>
    <title>Thanh toán - OriShop</title>
</head>

<body>
    <div layout:fragment="content" class="container py-5">
        <h2 class="mb-4 text-center">Thanh toán đơn hàng</h2>

        <div class="row">
            <!-- Cột thông tin giao hàng -->
            <div class="col-md-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h4 class="card-title mt-2">Thông tin giao hàng</h4>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/checkout}" method="post" id="checkoutForm">
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Họ và tên người nhận</label>
                                <input type="text" class="form-control" id="fullName" name="fullName" required
                                    placeholder="Nguyễn Văn A">
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required
                                    placeholder="09xxxxxxx">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ nhận hàng</label>

                                <!-- Selection from saved addresses -->
                                <div th:if="${not #lists.isEmpty(addresses)}" class="mb-3">
                                    <div class="list-group">
                                        <label class="list-group-item d-flex gap-2" th:each="addr : ${addresses}">
                                            <input class="form-check-input flex-shrink-0" type="radio"
                                                name="selectedAddress"
                                                th:value="${addr.detailAddress + ', ' + addr.ward + ', ' + addr.district + ', ' + addr.city}"
                                                th:checked="${addr.isDefault}" th:data-phone="${addr.phoneNumber}"
                                                onchange="updateAddressFromSelection(this)">
                                            <span>
                                                <strong th:text="${addr.detailAddress}">Address</strong><br>
                                                <small class="text-muted">
                                                    <span th:text="${addr.ward}">Ward</span>,
                                                    <span th:text="${addr.district}">District</span>,
                                                    <span th:text="${addr.city}">City</span>
                                                </small>
                                            </span>
                                        </label>
                                    </div>
                                    <div class="form-text">Chọn từ sổ địa chỉ hoặc nhập mới bên dưới.</div>
                                </div>

                                <textarea class="form-control" id="address" name="address" rows="3" required
                                    placeholder="Số nhà, đường, phường/xã..."
                                    th:text="${addresses != null and not #lists.isEmpty(addresses) ? (addresses.?[isDefault == true].isEmpty() ? '' : (addresses.?[isDefault == true][0].detailAddress + ', ' + addresses.?[isDefault == true][0].ward + ', ' + addresses.?[isDefault == true][0].district + ', ' + addresses.?[isDefault == true][0].city)) : ''}"></textarea>
                            </div>

                            <script>
                                function updateAddressFromSelection(radio) {
                                    document.getElementById('address').value = radio.value;
                                    // Optional: update phone if needed
                                    // document.getElementById('phone').value = radio.getAttribute('data-phone');
                                }
                            </script>
                            <div class="mb-3">
                                <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                                <textarea class="form-control" id="note" name="note" rows="2"
                                    placeholder="Ghi chú về đơn hàng, ví dụ: thời gian nhận hàng"></textarea>
                            </div>

                            <h4 class="mt-4">Phương thức thanh toán</h4>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD"
                                    checked>
                                <label class="form-check-label" for="cod">
                                    Thanh toán khi nhận hàng (COD)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="vnpay"
                                    value="VNPAY">
                                <label class="form-check-label" for="vnpay">
                                    Thanh toán qua VNPay
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="momo"
                                    value="MOMO">
                                <label class="form-check-label" for="momo">
                                    Thanh toán qua MoMo
                                </label>
                            </div>
                            <div class="form-check disabled">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="banking"
                                    value="BANKING" disabled>
                                <label class="form-check-label text-muted" for="banking">
                                    Chuyển khoản ngân hàng (Đang bảo trì)
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Cột tóm tắt đơn hàng -->
            <div class="col-md-5">
                <div class="card shadow-sm bg-light">
                    <div class="card-body">
                        <h4 class="card-title mb-3">Đơn hàng của bạn</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between lh-sm"
                                th:each="item : ${cartItems}">
                                <div>
                                    <h6 class="my-0" th:text="${item.productName}">Product name</h6>
                                    <small class="text-muted" th:text="'x ' + ${item.quantity}">x 1</small>
                                </div>
                                <span class="text-muted"
                                    th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">100.000</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between lh-sm"
                                th:if="${discountAmount != null && discountAmount > 0}">
                                <div class="text-success">
                                    <h6 class="my-0">Mã giảm giá</h6>
                                    <small>Đã áp dụng</small>
                                </div>
                                <span class="text-success"
                                    th:text="'- ' + ${#numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'">-
                                    0 đ</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between bg-white fw-bold">
                                <span>Tổng cộng (VND)</span>
                                <strong class="text-danger"
                                    th:text="${#numbers.formatDecimal(finalTotal != null ? finalTotal : cartTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">0
                                    đ</strong>
                            </li>
                        </ul>

                        <button type="submit" form="checkoutForm" class="btn btn-primary w-100 btn-lg">Đặt hàng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>