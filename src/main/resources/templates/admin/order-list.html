<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{decorators/admin}">

<head>
    <title>Đơn hàng - OriShop Admin</title>
</head>

<body>
    <div layout:fragment="content">
        <h2 class="mb-4">Quản lý Đơn hàng</h2>

        <!-- Order Status Tabs -->
        <ul class="nav nav-pills mb-4">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentStatus == null} ? 'active'" href="/admin/orders">Tất cả</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'PENDING'} ? 'active'"
                    href="/admin/orders?status=PENDING">Chờ xử lý</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'CONFIRMED'} ? 'active'"
                    href="/admin/orders?status=CONFIRMED">Đã xác nhận</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'SHIPPING'} ? 'active'"
                    href="/admin/orders?status=SHIPPING">Đang giao</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'COMPLETED'} ? 'active'"
                    href="/admin/orders?status=COMPLETED">Hoàn thành</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'RETURN_REQUESTED'} ? 'active'"
                    href="/admin/orders?status=RETURN_REQUESTED">Yêu cầu hoàn trả</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'REFUND_REQUESTED'} ? 'active'"
                    href="/admin/orders?status=REFUND_REQUESTED">Yêu cầu hoàn tiền</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'RETURNED'} ? 'active'"
                    href="/admin/orders?status=RETURNED">Đã hoàn trả</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                    th:classappend="${currentStatus != null && currentStatus.name() == 'CANCELLED'} ? 'active'"
                    href="/admin/orders?status=CANCELLED">Đã hủy</a>
            </li>
        </ul>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Mã ĐH</th>
                        <th>Ngày đặt</th>
                        <th>Khách hàng</th>
                        <th>Tổng tiền</th>
                        <th>Thanh toán</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${orders}">
                        <td th:text="${order.orderCode} ?: ${order.id}">#123</td>
                        <td th:text="${#dates.format(order.createdAt, 'dd-MM-yyyy HH:mm')}">Date</td>
                        <td
                            th:text="${order.shippingName != null ? order.shippingName : (order.user != null ? order.user.fullName : 'Khách lẻ')}">
                            Customer</td>
                        <td th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' đ'">Total
                        </td>
                        <td>
                            <form th:action="@{/admin/orders/update-payment-status}" method="post">
                                <input type="hidden" name="id" th:value="${order.id}">
                                <input type="hidden" name="paymentStatus" th:value="${!order.paymentStatus}">
                                <button type="submit"
                                    th:class="'btn btn-sm ' + (${order.paymentStatus} ? 'btn-success' : 'btn-warning')"
                                    th:text="${order.paymentStatus} ? 'Đã thanh toán' : 'Chưa thanh toán'">
                                </button>
                            </form>
                        </td>
                        <td>
                            <span th:class="'badge ' +
                                (${order.status.name() == 'PENDING'} ? 'bg-warning' :
                                (${order.status.name() == 'CONFIRMED'} ? 'bg-primary' :
                                (${order.status.name() == 'SHIPPING'} ? 'bg-info' :
                                (${order.status.name() == 'DELIVERED'} ? 'bg-success' : 
                                (${order.status.name() == 'COMPLETED'} ? 'bg-success' : 
                                (${order.status.name() == 'RETURN_REQUESTED'} ? 'bg-warning text-dark' :
                                (${order.status.name() == 'REFUND_REQUESTED'} ? 'bg-danger text-light' :
                                (${order.status.name() == 'RETURNED'} ? 'bg-secondary' : 'bg-danger'))))))))"
                                th:text="${order.status.name() == 'PENDING' ? 'Chờ xử lý' : 
                                          (order.status.name() == 'CONFIRMED' ? 'Đã xác nhận' :
                                          (order.status.name() == 'SHIPPING' ? 'Đang giao' :
                                          (order.status.name() == 'DELIVERED' ? 'Đã giao' :
                                          (order.status.name() == 'COMPLETED' ? 'Hoàn thành' : 
                                          (order.status.name() == 'RETURN_REQUESTED' ? 'Yêu cầu hoàn trả' :
                                          (order.status.name() == 'REFUND_REQUESTED' ? 'Yêu cầu hoàn tiền' :
                                          (order.status.name() == 'RETURNED' ? 'Đã hoàn trả' : 'Đã hủy')))))))}">PENDING</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-info">Chi tiết</a>
                            <form th:if="${order.status.name() == 'RETURN_REQUESTED'}"
                                th:action="@{/admin/orders/update-status}" method="post" class="d-inline">
                                <input type="hidden" name="id" th:value="${order.id}">
                                <!-- Changed from orderId to id to match controller -->
                                <input type="hidden" name="status" value="RETURNED">
                                <button type="submit" class="btn btn-sm btn-success"
                                    onclick="return confirm('Xác nhận chấp nhận hoàn trả đơn hàng này?')">
                                    Chấp nhận
                                </button>
                            </form>
                            <a th:href="@{/admin/orders/delete/{id}(id=${order.id})}" class="btn btn-sm btn-danger"
                                onclick="return confirm('Bạn có chắc chắn muốn xóa đơn hàng này?');">Xóa</a>
                        </td>
                    </tr>
                    <tr th:if="${orders.isEmpty()}">
                        <td colspan="6" class="text-center">Chưa có đơn hàng nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>